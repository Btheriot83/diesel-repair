---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import { buildInternalLinks } from "@/utils/linkBuilder";
import { COMPANY_CONFIG } from "@/config/constants";
import { BUSINESS_NAME, PHONE_E164, PHONE_DISPLAY, COMPANY_LAT, COMPANY_LNG, SERVICE_RADIUS_METERS } from "@/config/company";
import HeroCity from "@/components/HeroCity.astro";
import CorridorsGrid from "@/components/locations/CorridorsGrid.astro";
import FAQAccordion from "@/components/ui/FAQAccordion.astro";
import DispatchCard from "@/components/DispatchCard.astro";
import { getHeroPreload } from "@/utils/heroPreload";
import citiesData from "@/data/cities.json";

export async function getStaticPaths() {
  const entries = await getCollection("locations");
  return entries.map((e) => ({ params: { slug: e.slug } }));
}

const { slug } = Astro.params;
const entry = await getEntry("locations", slug);
if (!entry) throw new Error(`Location not found: ${slug}`);

// Render MDX content
const rendered = await entry.render();
const { Content } = rendered;
const data = entry.data;

// Merge with cities.json data
const cityJsonData = citiesData.find(city => city.slug === slug);
const mergedData = cityJsonData ? { ...cityJsonData, ...data } : data;

const links = buildInternalLinks(mergedData);

// Enhanced local SEO data
const cityName = (mergedData.title.split('—')[1]?.trim() || mergedData.city || 'Phoenix').split(',')[0].trim();
const isPhoenix = cityName?.toLowerCase()?.includes('phoenix') || false;

// Hero image selection with AVIF/WebP optimization
const heroOptions = [
  `/images/hero/diesel-truck-${slug}-1.avif`,
  `/images/hero/diesel-truck-${slug}-2.avif`,
  `/images/hero/diesel-truck-repair-${slug}.avif`,
  `/images/hero/mobile-diesel-${cityName?.toLowerCase() || 'phoenix'}.avif`,
  `/images/hero/diesel-truck-phoenix-highway.avif`
];

const heroImage = heroOptions[0]; // Use first option as primary
const heroPreload = await getHeroPreload(heroImage);

// City defaults fallback system
const cityDefaults = {
  corridors: mergedData.corridors || [
    `I-10 ${cityName} Area Coverage`,
    `I-17 ${cityName} Corridor Access`,
    `Loop System ${cityName} Metro`
  ],
  landmarks: mergedData.landmarks || [
    `${cityName} distribution centers`,
    `Local freight facilities`,
    `Major corridor intersections`,
    `Industrial zones & logistics hubs`
  ],
  nearbyCities: mergedData.nearbyCities || ["Phoenix", "Tempe", "Mesa", "Chandler", "Glendale"],
  relatedServices: mergedData.relatedServices || ["emergency-roadside-assistance", "engine-diagnostics", "brakes-air-systems"],
  faqs: mergedData.faqs || [
    {
      question: `Do you provide emergency service in ${cityName}?`,
      answer: `Yes, we provide 24/7 emergency mobile diesel repair throughout ${cityName} and surrounding areas. Typical response time is 30-90 minutes depending on location and traffic conditions.`
    },
    {
      question: `What types of diesel repairs do you handle in ${cityName}?`,
      answer: `We handle all diesel engine repairs, brake and air systems, hydraulics, electrical issues, A/C systems, and emergency roadside assistance throughout ${cityName} and the greater Phoenix metro area.`
    }
  ]
};

// Enhanced SEO meta data
const pageTitle = mergedData.metaTitle || `Mobile Diesel Mechanic ${cityName} | 24/7 On‑Site Truck Repair`;
const pageDescription = mergedData.metaDescription || `Mobile diesel repair in ${cityName} with 24/7 emergency dispatch. Serving ${cityDefaults.corridors.slice(0,2).join(', ')} with professional on-site service.`;
const canonicalUrl = mergedData.canonical || `https://azmobiledieselrepair.com/locations/${slug}`;

// SAB (Service Area Business) JSON-LD Schema
const sabSchema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "LocalBusiness",
      "@id": `https://azmobiledieselrepair.com/locations/${slug}#LocalBusiness`,
      "name": BUSINESS_NAME,
      "telephone": PHONE_E164,
      "url": `https://azmobiledieselrepair.com/locations/${slug}`,
      "logo": "https://azmobiledieselrepair.com/images/az-mobile-diesel-logo.png",
      "image": "https://azmobiledieselrepair.com/images/hero/diesel-truck-repair-team.jpg",
      "description": `Professional mobile diesel repair serving ${cityName}, Arizona. 24/7 emergency roadside assistance and on-site diesel engine repair.`,
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": mergedData.centroid?.lat || COMPANY_LAT,
        "longitude": mergedData.centroid?.lng || COMPANY_LNG
      },
      "areaServed": {
        "@type": "GeoCircle",
        "geoMidpoint": {
          "@type": "GeoCoordinates",
          "latitude": mergedData.centroid?.lat || COMPANY_LAT,
          "longitude": mergedData.centroid?.lng || COMPANY_LNG
        },
        "geoRadius": SERVICE_RADIUS_METERS
      },
      "serviceArea": [
        {
          "@type": "City",
          "name": cityName,
          "addressRegion": "AZ",
          "addressCountry": "US"
        }
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Mobile Diesel Repair Services",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Emergency Roadside Assistance",
              "description": "24/7 mobile diesel repair emergency service"
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Engine Diagnostics",
              "description": "Computer diagnostics and ECM programming"
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Brake & Air Systems",
              "description": "Mobile brake repair and air system service"
            }
          }
        ]
      },
      "openingHours": "Mo-Su 00:00-23:59",
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": PHONE_E164,
        "contactType": "customer service",
        "availableLanguage": "English"
      }
    },
    {
      "@type": "FAQPage",
      "@id": `https://azmobiledieselrepair.com/locations/${slug}#FAQPage`,
      "mainEntity": cityDefaults.faqs.map((faq, index) => ({
        "@type": "Question",
        "@id": `https://azmobiledieselrepair.com/locations/${slug}#Question${index + 1}`,
        "name": faq.question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": faq.answer
        }
      }))
    },
    {
      "@type": "BreadcrumbList",
      "@id": `https://azmobiledieselrepair.com/locations/${slug}#BreadcrumbList`,
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://azmobiledieselrepair.com/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Locations",
          "item": "https://azmobiledieselrepair.com/locations/"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": cityName,
          "item": `https://azmobiledieselrepair.com/locations/${slug}`
        }
      ]
    }
  ]
};
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalUrl}
  ogImage={`https://azmobiledieselrepair.com/images/og/diesel-repair-${slug}.jpg`}
  preload={[heroPreload]}
>
  <script type="application/ld+json" set:html={JSON.stringify(sabSchema)} />

  <!-- Hero Section with City-Specific Background -->
  <HeroCity
    city={cityName}
    state="Arizona"
    corridors={cityDefaults.corridors}
    phone={PHONE_DISPLAY}
    phoneLink={PHONE_E164}
    heroImage={heroImage}
    etaMinutes={mergedData.etaMinutes || 45}
  />

  <main class="space-y-16 pt-8">
    <!-- Emergency Dispatch Section -->
    <section class="bg-red-600 text-white py-16">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl font-bold mb-6">24/7 Emergency Dispatch - {cityName}</h2>
          <p class="text-xl mb-8">Stranded on {cityDefaults.corridors[0] || 'the highway'}? Our emergency response team is standing by.</p>
          <div class="grid md:grid-cols-2 gap-8">
            <DispatchCard
              type="emergency"
              title="Emergency Roadside"
              description="Immediate response for breakdowns and emergencies"
              responseTime={`${mergedData.etaMinutes || 45}-90 min`}
              phone={PHONE_DISPLAY}
              phoneLink={PHONE_E164}
            />
            <DispatchCard
              type="scheduled"
              title="Scheduled Service"
              description="On-site repair at your location or facility"
              responseTime="Same day"
              phone={PHONE_DISPLAY}
              phoneLink={PHONE_E164}
            />
          </div>
        </div>
      </div>
    </section>

    <!-- Corridor Coverage Section -->
    <section class="py-16">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-center mb-12">
            {cityName} Corridor Coverage
          </h2>
          <CorridorsGrid
            corridors={cityDefaults.corridors}
            city={cityName}
            landmarks={cityDefaults.landmarks}
            etaMinutes={mergedData.etaMinutes || 45}
          />
        </div>
      </div>
    </section>

    <!-- Services Grid Section -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <h2 class="text-3xl font-bold text-center mb-12">
            Mobile Diesel Services in {cityName}
          </h2>
          <div class="grid md:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Emergency Roadside Assistance</h3>
              <p class="text-gray-600 mb-4">24/7 emergency response for breakdowns, lockouts, and roadside repairs throughout {cityName}.</p>
              <a href="/services/emergency-roadside-assistance" class="text-orange-600 font-semibold hover:text-orange-700">Learn More →</a>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Engine Diagnostics</h3>
              <p class="text-gray-600 mb-4">Computer diagnostics, ECM programming, and engine repair services at your {cityName} location.</p>
              <a href="/services/engine-diagnostics" class="text-orange-600 font-semibold hover:text-orange-700">Learn More →</a>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Brakes & Air Systems</h3>
              <p class="text-gray-600 mb-4">Complete brake and air system repair, including wheel seals and foundation brake work.</p>
              <a href="/services/brakes-air-systems" class="text-orange-600 font-semibold hover:text-orange-700">Learn More →</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Local Expertise Section -->
    <section class="py-16">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-center mb-12">
            Local {cityName} Expertise
          </h2>
          <div class="prose prose-lg mx-auto text-center">
            <Content />
            {mergedData.heatNotes && mergedData.heatNotes.length > 0 && (
              <div class="bg-orange-50 p-6 rounded-lg mt-8">
                <h3 class="text-xl font-semibold text-orange-800 mb-4">Local Conditions & Challenges</h3>
                <ul class="text-left text-orange-700">
                  {mergedData.heatNotes.map((note: string) => (
                    <li class="mb-2">• {note}</li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-center mb-12">
            Frequently Asked Questions - {cityName}
          </h2>
          <FAQAccordion faqs={cityDefaults.faqs} />
        </div>
      </div>
    </section>

    <!-- Nearby Areas Section -->
    <section class="py-16">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl font-bold mb-8">Nearby Service Areas</h2>
          <p class="text-lg text-gray-600 mb-8">
            We also provide mobile diesel repair services in these nearby cities:
          </p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {cityDefaults.nearbyCities.slice(0, 6).map((city: string) => (
              <a
                href={`/locations/${city?.toLowerCase()}`}
                class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200 hover:border-orange-300"
              >
                <span class="font-semibold text-gray-800 hover:text-orange-600">
                  {city}
                </span>
              </a>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Final CTA Section -->
    <section class="py-16 bg-orange-600 text-white">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl font-bold mb-6">
            Ready for Expert Diesel Repair in {cityName}?
          </h2>
          <p class="text-xl mb-8">
            Call now for immediate dispatch to your {cityName} location.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href={`tel:${PHONE_E164}`}
              class="bg-white text-orange-600 px-8 py-4 rounded-full font-bold text-lg hover:bg-gray-100 transition-colors"
            >
              Call {PHONE_DISPLAY}
            </a>
            <a
              href="#contact-form"
              class="border-2 border-white text-white px-8 py-4 rounded-full font-bold text-lg hover:bg-white hover:text-orange-600 transition-colors"
            >
              Request Service
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>